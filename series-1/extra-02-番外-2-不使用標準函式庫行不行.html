<!DOCTYPE HTML>
<html lang="zh-TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>番外 2： 不使用標準函式庫行不行？ - Rust Ironman 合併彙整</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Ironman 合併彙整</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="番外-2-不使用標準函式庫行不行"><a class="header" href="#番外-2-不使用標準函式庫行不行">番外 2： 不使用標準函式庫行不行？</a></h1>
<ul>
<li>系列：30 天深入淺出 Rust</li>
<li>來源系列：https://ithelp.ithome.com.tw/users/20111802/ironman/1742</li>
<li>原文連結：https://ithelp.ithome.com.tw/articles/10207917</li>
<li>章節：番外 2</li>
<li>發佈時間：2018-11-04 13:50:34</li>
<li>作者：DanSnow</li>
<li>清單瀏覽數：2877</li>
<li>清單摘要：Rust 的基本函式庫其實包的東西算很少了，不過還是挺大的，因為 Rust 的標準函式庫並沒有預裝在各個電腦上，所以 Rust 都是直接把必要的部份也直接包含進...</li>
</ul>
<h2 id="內文"><a class="header" href="#內文">內文</a></h2>
<p>Rust 的基本函式庫其實包的東西算很少了，不過還是挺大的，因為 Rust
的標準函式庫並沒有預裝在各個電腦上，所以 Rust
都是直接把必要的部份也直接包含進執行檔裡 (靜態連結 static
link)，如果我們看一下基本的 Hello world 有多大的話：</p>
<pre><code class="language-plain">File  .text     Size     Crate Name
4.6%  62.7% 179.2KiB           [819 Others]
0.2%   3.3%   9.5KiB [Unknown] stats_arena_print
0.2%   3.0%   8.6KiB       std std::sys_common::backtrace::output
0.2%   2.9%   8.4KiB [Unknown] read_line_info
0.2%   2.7%   7.7KiB       std je_stats_print
0.2%   2.7%   7.7KiB       std mallocx
0.2%   2.4%   6.9KiB       std je_arena_boot
0.2%   2.3%   6.5KiB [Unknown] elf_add
0.2%   2.2%   6.4KiB       std backtrace_dwarf_add
0.2%   2.1%   6.1KiB       std je_malloc_vsnprintf
0.1%   1.5%   4.2KiB       std je_arena_palloc
0.1%   1.4%   4.0KiB [Unknown] read_attribute
0.1%   1.4%   3.9KiB       std realloc
0.1%   1.3%   3.8KiB [Unknown] malloc_init_hard_a0_locked
0.1%   1.3%   3.8KiB       std std::sys_common::backtrace::print
0.1%   1.3%   3.8KiB [Unknown] elf_zlib_inflate_and_verify
0.1%   1.1%   3.1KiB       std calloc
0.1%   1.1%   3.1KiB       std malloc
0.1%   1.1%   3.0KiB       std rallocx
0.1%   1.1%   3.0KiB       std je_arena_ralloc_no_move
0.1%   1.0%   2.9KiB       std je_arena_ralloc
7.3% 100.0% 285.6KiB           .text section size, the file size is 3.8MiB
</code></pre>
<blockquote>
<p>這是 <a href="https://github.com/RazrFalcon/cargo-bloat">cargo-bloat</a>
輸出的結果，可以自己安裝來嘗試看看，另外若使用 <code>strip</code>
指令去除掉執行檔的除錯資訊，執行檔的大小會下降到 424 KB ，只是這樣
cargo-bloat 就沒辦法印出每個函式佔的大小了。</p>
</blockquote>
<p>程式碼的區塊的大小在最後一行，單程式碼的部份就佔了 285.6 KB
，整個執行檔的大小有 3.8 MB ，很大嗎？如果我們用 C 寫一個 Hello world
，執行檔才 8.3 KB 而已，程式碼的部份只有 418 Byte ，程式碼的部份差了約
700 倍啊。</p>
<blockquote>
<p>這樣比較也不完全正確，因為 C 的標準函式庫都有安裝在系統中，並不像 Rust
是編譯進執行檔中， C 的標準函式庫大小是 2 MB
，但實際上用到的也並沒有全部，若使用靜態連結的話， C
編譯出來的檔案程式的區塊佔了約 573 KB 喔</p>
</blockquote>
<p>在上面的輸出可以看到比如像 <code>backtrace</code> 、 <code>je_*</code> 等等的東西，
<code>backtrace</code> 是 Rust 在程式發生 panic 時可以印出程式呼叫的流程，而 je
開頭的則是 Rust 預設使用的記憶體分配函式庫，叫
<a href="http://jemalloc.net/">jemalloc</a> ，就像 C 裡使用的 malloc 一樣，
jemalloc
速度較快，同時它盡可能避免在多執行緒時使用鎖定，不過它還挺大的。</p>
<p>如果我們不要用 jemalloc 會怎麼樣呢， Rust 在 1.28 版新增了
<code>global_allocator</code> 這個 API 讓我們可以換掉預設使用的記憶體分配器：</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 系統預設的記憶分配器，簡單來說就是 malloc
use std::alloc::System;

// 設定全域的記憶體分配器，這只能設定一次，如果設定兩次以上會出錯
#[global_allocator]
static GLOBAL: System = System;
<span class="boring">}</span></code></pre></pre>
<p>設定完後的結果：</p>
<pre><code class="language-plain">File  .text     Size     Crate Name
2.2%  50.4%  62.7KiB           [434 Others]
0.3%   6.9%   8.6KiB       std std::sys_common::backtrace::output
0.3%   6.8%   8.4KiB [Unknown] read_line_info
0.2%   5.2%   6.5KiB [Unknown] elf_add
0.2%   5.1%   6.4KiB       std backtrace_dwarf_add
0.1%   3.2%   4.0KiB [Unknown] read_attribute
0.1%   3.0%   3.8KiB [Unknown] elf_zlib_inflate_and_verify
0.1%   3.0%   3.7KiB       std std::sys_common::backtrace::print
0.1%   1.8%   2.2KiB       std core::str::pattern::StrSearcher::new
0.1%   1.8%   2.2KiB [Unknown] read_function_entry
0.1%   1.6%   1.9KiB       std backtrace_qsort
0.1%   1.3%   1.6KiB [Unknown] add_function_ranges
0.1%   1.3%   1.6KiB [Unknown] dwarf_lookup_pc
0.1%   1.3%   1.6KiB [Unknown] add_unit_ranges
0.1%   1.2%   1.5KiB [Unknown] find_address_ranges
0.0%   1.1%   1.4KiB       std core::fmt::Formatter::pad
0.0%   1.0%   1.3KiB       std std::sys_common::backtrace::output_fileline
0.0%   1.0%   1.3KiB       std std::sys::unix::backtrace::printing::resolve_symname
0.0%   1.0%   1.2KiB       std core::fmt::Formatter::pad_integral
0.0%   1.0%   1.2KiB       std &lt;str as core::fmt::Debug&gt;::fmt
0.0%   1.0%   1.2KiB       std std::sys::unix::backtrace::printing::dladdr::resolve_symname
4.4% 100.0% 124.4KiB           .text section size, the file size is 2.8MiB
</code></pre>
<p>少了一半以上啊。</p>
<blockquote>
<p><a href="https://github.com/rust-lang/rust/pull/55238">PR #55238</a> 官方正在從
jemalloc 換回系統預設的 malloc 喔，如果你用 nightly 版的
<code>8b096314a 2018-11-02</code> ，那應該已經包含這個 PR
了，只是我實驗後似乎還是把 jemalloc 編進去了</p>
</blockquote>
<h2 id="no_std"><a class="header" href="#no_std"><code>#![no_std]</code></a></h2>
<p>終於進入這篇的重點了，如果我們不使用標準函式庫會怎麼樣呢？聽起來很不可思議，但其實是可以的，
Rust 其實還提供了一個只有最基本的功能的函式庫，叫
<a href="https://doc.rust-lang.org/stable/core/index.html">core</a>
，基本到什麼程度呢？只有最基礎的型態，所有與記憶體分配或是與系統相關的東西都沒有，比如輸入輸出。</p>
<p>這個函式庫主要用在一些特殊的環境，比如嵌入式系統這種系統架構可能不同的時候，這時候使用者可以自己提供操作系統的
API 綁定，只使用這個最基本的函式庫來寫 Rust 的程式。</p>
<p>那如果我們只使用 core 來寫 Hello world 會變怎麼樣呢？但因為 core
沒有輸入輸出，若我們要在螢幕上顯示東西就必須找其它辦法，其實很簡單，直接呼叫
C 的標準函式庫的東西就好了：</p>
<pre><pre class="playground"><code class="language-rust">// 不要使用標準函式庫
#![no_std]
// 不要用 Rust 預設的 main
#![no_main]

// 提供 C 標準函式庫綁定的 crate
extern crate libc;

// 這邊就變的跟 C 的 main 一樣了
#[no_mangle]
pub extern "C" fn main() -&gt; i32 {
    unsafe {
        libc::puts("Hello world\0".as_ptr() as _);
    }
    0
}</code></pre></pre>
<p>加入 libc 的相依性時要調一下設定，讓它不要使用到原本的 std ：</p>
<pre><code class="language-toml">libc = { version = "0.2.43", default-features = false }
</code></pre>
<p>為什麼不要用預設的 main 呢？有興趣可以看一下這段
<a href="https://github.com/rust-lang/rust/blob/master/src/libstd/rt.rs#L32-L67">程式碼</a>
， Rust 預設會設定在 panic
發生時印出訊息等等的機制，只是這些我們現在沒辦法提供，就直接用跟 C
一樣的 main 當程式的進入點吧。</p>
<p>若編譯上面那個程式你會看到以下兩個錯誤：</p>
<pre><code class="language-plain">error: `#[panic_handler]` function required, but not found

error: language item required, but not found: `eh_personality`
</code></pre>
<p>我們的程式缺少了兩個函式，這兩個函式是在發生特殊情況時由編譯器產生的程式碼去呼叫的，第一個是
panic 發生時呼叫的，用來印出訊息用的，第二個則是提供 panic 發生的 unwind
機制，讓程式能從 panic 的狀態回復而繼續執行下去，先處理第二個，在
<code>Cargo.toml</code> 加上這些設定：</p>
<pre><code class="language-toml">[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
</code></pre>
<p>這讓編譯出來的程式在 panic 時直接結束，而不要嘗試 unwind ，這樣就不需要
<code>eh_personality</code> 了，第一個要處理也很簡單，提供一個就行了：</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use core::panic::PanicInfo;

#[panic_handler]
fn panic(_: &amp;PanicInfo) -&gt; ! {
    unsafe {
        libc::abort();
    }
}
<span class="boring">}</span></code></pre></pre>
<p>在 panic 發生時直接呼叫 <code>abort</code>
結束程式，到這邊我們的程式應該能編譯執行了，來看看編譯後的大小：</p>
<pre><code class="language-plain">File  .text Size     Crate Name
0.0%   0.0%   0B           [0 Others]
0.7%  45.1% 101B [Unknown] __libc_csu_init
0.4%  23.7%  53B [Unknown] main
0.3%  19.2%  43B [Unknown] _start
0.2%  11.2%  25B       std core::str::&lt;impl str&gt;::as_ptr
0.0%   0.9%   2B [Unknown] __libc_csu_fini
1.6% 100.0% 224B           .text section size, the file size is 13.5KiB
</code></pre>
<p>程式碼區塊只剩下 224 Byte ，如果用 release 模式的話：</p>
<pre><code class="language-plain">File  .text Size     Crate Name
0.0%   0.0%   0B           [0 Others]
1.2%  61.6% 101B [Unknown] __libc_csu_init
0.5%  26.2%  43B [Unknown] _start
0.2%  11.0%  18B [Unknown] main
0.0%   1.2%   2B [Unknown] __libc_csu_fini
2.0% 100.0% 164B           .text section size, the file size is 7.9KiB
</code></pre>
<p>只剩下 164 Byte 了。</p>
<p>目前 <code>no_std</code> 最常被使用到的地方應該是 crate 了，在 crates.io 上還有個
<a href="https://crates.io/categories/no-std">專門的分類</a> ，這些 crate
提供使用者在特殊的環境下也能使用的功能，通常也都是完全不牽涉到作業系統相關的東西的。</p>
<p>另外 Rust 的標準函式庫還有個叫
<a href="https://doc.rust-lang.org/stable/alloc/index.html">alloc</a>
，目前還不穩定，它提供的是與記憶體分配相關的，比如像智慧指標 <code>Box</code>
，或是 Rust 中的 <code>Vec</code> 等等。</p>
<p>不過除非你是想在特殊的環境下使用 Rust ，或是你做了個跟作業系統完全無關的
crate ，不然還是用 std 來的方便，不需要為了想幫 Rust 的程式瘦身就不用
std 。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../series-1/extra-01-番外-1-設計模式.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../series-1/extra-03-番外-3-rust-2018-const-fn-inline-asm.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../series-1/extra-01-番外-1-設計模式.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../series-1/extra-03-番外-3-rust-2018-const-fn-inline-asm.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
